<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="2025-05-14-09-test-user-belong-data" author="claude">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="USER_BELONG"/>
            <sqlCheck expectedResult="2">
                SELECT COUNT(*) FROM USERS WHERE ID IN (1,2)
            </sqlCheck>
            <sqlCheck expectedResult="2">
                SELECT COUNT(*) FROM TASK WHERE ID IN (1,2)
            </sqlCheck>
        </preConditions>

        <comment>Добавление тестовых назначений пользователей на задачи</comment>

        <!-- Вставка назначений -->
        <sql>
            INSERT INTO USER_BELONG (OBJECT_ID, OBJECT_TYPE, USER_ID, USER_TYPE_CODE, STARTPOINT, ENDPOINT)
            VALUES
                (1, 2, 2, 'task_developer', '2023-06-14 08:35:10', '2023-06-14 08:55:00'),
                (1, 2, 2, 'task_reviewer', '2023-06-14 09:35:10', NULL),
                (1, 2, 1, 'task_developer', '2023-06-12 11:40:00', '2023-06-12 12:35:00'),
                (1, 2, 1, 'task_developer', '2023-06-13 12:35:00', NULL),
                (1, 2, 1, 'task_tester', '2023-06-14 15:20:00', NULL),
                (2, 2, 2, 'task_developer', '2023-06-08 07:10:00', NULL),
                (2, 2, 1, 'task_developer', '2023-06-09 14:48:00', NULL),
                (2, 2, 1, 'task_tester', '2023-06-10 16:37:00', NULL);
        </sql>

        <!-- Создание составного индекса для часто используемых запросов -->
        <createIndex tableName="USER_BELONG" indexName="IDX_USER_BELONG_OBJECT">
            <column name="OBJECT_ID"/>
            <column name="OBJECT_TYPE"/>
        </createIndex>

        <createIndex tableName="USER_BELONG" indexName="IDX_USER_BELONG_USER">
            <column name="USER_ID"/>
            <column name="USER_TYPE_CODE"/>
        </createIndex>

        <!-- Уникальный индекс для активных записей -->
        <sql>
            CREATE UNIQUE INDEX IF NOT EXISTS UK_USER_BELONG_ACTIVE ON USER_BELONG
                (OBJECT_ID, OBJECT_TYPE, USER_ID, USER_TYPE_CODE)
                WHERE ENDPOINT IS NULL;
        </sql>
    </changeSet>
</databaseChangeLog>